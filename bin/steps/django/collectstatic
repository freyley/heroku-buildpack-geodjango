#!/usr/bin/env bash

set +e

# Syntax sugar.
indent() {
  RE="s/^/       /"
  [ $(uname) == "Darwin" ] && sed -l "$RE" || sed -u "$RE"
}
export LIBRARY_PATH=.heroku/vendor/lib:.geodjango/proj4/lib:.geodjango/gdal/lib:.geodjango/geos/lib
export LD_LIBRARY_PATH=.heroku/vendor/lib:.geodjango/proj4/lib:.geodjango/gdal/lib:.geodjango/geos/lib
export GEOS_LIBRARY_PATH=.geodjango/geos/lib

echo "Checking if collectstatic can be run"
# Check if collectstatic is configured properly.
#python $MANAGE_FILE collectstatic --dry-run --noinput &> /dev/null && RUN_COLLECTSTATIC=true
/app/bin/python $MANAGE_FILE collectstatic --dry-run --noinput && RUN_COLLECTSTATIC=true

echo "Collectstatic can be run: $RUN_COLLECTSTATIC"
sleep 40

# Compile assets if collectstatic appears to be kosher.
if [ "$RUN_COLLECTSTATIC" ]; then

    echo "-----> Collecting static files"
    python $MANAGE_FILE collectstatic --noinput  2>&1 | sed '/^Copying/d;/^$/d;/^ /d' | indent

    [ $? -ne 0 ] && {
        echo " !     Error running manage.py collectstatic. More info:"
        echo "       http://devcenter.heroku.com/articles/django-assets"
    }
fi

echo

